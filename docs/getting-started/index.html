<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.59.1"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Getting Started | Cortex</title><meta property="og:title" content="Getting Started"><meta property="og:description" content="Cortex can be run as a single binary or as multiple independent microservices. The single-binary mode is easier to deploy and is aimed mainly at users wanting to try out Cortex or develop on it. The microservices mode is intended for production usage, as it allows you to independently scale different services and isolate failures. This document will focus on single-process Cortex. See the architecture doc For more information about the microservices."><meta property="og:type" content="article"><meta property="og:url" content="/docs/getting-started/"><meta property="og:image" content="/images/logo-twitter-card.jpg"><meta property="og:site_name" content="Cortex"><meta itemprop=name content="Getting Started"><meta itemprop=description content="Cortex can be run as a single binary or as multiple independent microservices. The single-binary mode is easier to deploy and is aimed mainly at users wanting to try out Cortex or develop on it. The microservices mode is intended for production usage, as it allows you to independently scale different services and isolate failures. This document will focus on single-process Cortex. See the architecture doc For more information about the microservices."><meta itemprop=wordCount content="767"><meta itemprop=keywords content><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/images/logo-twitter-card.jpg"><meta name=twitter:title content="Getting Started"><meta name=twitter:description content="Cortex can be run as a single binary or as multiple independent microservices. The single-binary mode is easier to deploy and is aimed mainly at users wanting to try out Cortex or develop on it. The microservices mode is intended for production usage, as it allows you to independently scale different services and isolate failures. This document will focus on single-process Cortex. See the architecture doc For more information about the microservices."><link rel=preload href=/scss/main.min.4ff813ae4617e8aa437e422dee0b5f0d0d29f44049ee9dc629d104243b05d88b.css as=style><link href=/scss/main.min.4ff813ae4617e8aa437e422dee0b5f0d0d29f44049ee9dc629d104243b05d88b.css rel=stylesheet integrity><link href=/css/offline-search.css rel=stylesheet><script src=https://code.jquery.com/jquery-3.3.1.min.js integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin=anonymous></script><script src=https://unpkg.com/lunr@2.1.6/lunr.js></script><script src=/js/offline-search.js></script><title>Getting Started | Cortex</title></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar navbar-nocover"><a id=cortex-logo class=navbar-brand href=/><span class=navbar-logo><svg xmlns="http://www.w3.org/2000/svg" role="img" viewBox="-17.92 -14.92 1191.84 462.84"><defs><style>.cls-1{fill:#fff}</style></defs><path d="M214.531 8.017C99.353 8.017 5.65 101.72 5.65 216.899S99.353 425.78 214.531 425.78s208.882-93.704 208.882-208.882S329.71 8.017 214.531 8.017zm0 408.558c-110.102.0-199.676-89.574-199.676-199.676S104.429 17.222 214.53 17.222 414.208 106.797 414.208 216.9 324.633 416.575 214.53 416.575z" class="cls-1"/><circle cx="327.452" cy="221.633" r="34.571" class="cls-1"/><circle cx="213.713" cy="353.584" r="34.571" class="cls-1"/><path d="M299.992 167.913l-59-56.05a34.578 34.578.0 1 0-4.343 4.34l57.828 54.937a60.158 60.158.0 0 0-27.168 49.123h-12.97l-23.456-67.02-26.055 64.718H175.73l-24.724 57.22-21.808-54.524-.063.025v-.586h-22.048a34.582 34.582.0 1 0-.275 6.138h18.005l25.97 64.925 28.977-67.06h29.207l21.51-53.424 19.503 55.725H267.5a60.173 60.173.0 0 0 25.202 44.11l-56.52 56.52 4.34 4.338 57.492-57.492a60.155 60.155.0 1 0 1.977-105.963zm81.481 53.515a54.02 54.02.0 1 1-54.022-54.02 54.083 54.083.0 0 1 54.022 54.02zm175.707 42.568q-8.797 8.178-24.405 8.177a34.858 34.858.0 0 1-17.095-3.965 33.188 33.188.0 0 1-11.643-10.529 46.374 46.374.0 0 1-6.566-14.99 71.134 71.134.0 0 1-2.105-17.341 86.99 86.99.0 0 1 1.982-18.706 46.804 46.804.0 0 1 6.565-15.98 34.028 34.028.0 0 1 12.263-11.149q7.675-4.21 19.077-4.212 13.38.0 21.306 6.69 7.927 6.689 10.405 18.829h21.803a50.76 50.76.0 0 0-5.946-19.696 44.06 44.06.0 0 0-12.015-13.75 49.842 49.842.0 0 0-16.848-8.051 77.44 77.44.0 0 0-20.44-2.601q-15.114.0-26.509 5.326a52.935 52.935.0 0 0-18.952 14.617 62.165 62.165.0 0 0-11.273 21.8 94.013 94.013.0 0 0-3.717 26.883 86.195 86.195.0 0 0 3.84 26.386 57.783 57.783.0 0 0 11.397 20.686 50.138 50.138.0 0 0 18.829 13.38 66.766 66.766.0 0 0 25.891 4.705q24.527.0 38.772-12.882 14.245-12.878 17.715-36.668h-21.556q-1.986 14.867-10.776 23.041zm157.44-87.828a56.338 56.338.0 0 0-19.447-14.244q-11.52-5.203-26.882-5.203-15.115.0-26.756 5.203a56.009 56.009.0 0 0-19.573 14.244 59.75 59.75.0 0 0-11.892 21.307 85.299 85.299.0 0 0-3.965 26.386 84.117 84.117.0 0 0 3.965 26.262 59.853 59.853.0 0 0 11.892 21.183 54.61 54.61.0 0 0 19.573 14.12q11.643 5.077 26.756 5.08 15.36.0 26.882-5.08a54.908 54.908.0 0 0 19.447-14.12 59.95 59.95.0 0 0 11.892-21.183 84.181 84.181.0 0 0 3.965-26.262 85.364 85.364.0 0 0-3.965-26.386 59.846 59.846.0 0 0-11.892-21.307zm-9.538 68.38a43.305 43.305.0 0 1-8.548 15.113 37.061 37.061.0 0 1-12.759 9.29 38.825 38.825.0 0 1-30.968.0 37.003 37.003.0 0 1-12.76-9.29 43.209 43.209.0 0 1-8.547-15.114 70.669 70.669.0 0 1 0-41.373 44.634 44.634.0 0 1 8.547-15.237 36.428 36.428.0 0 1 12.76-9.415 38.826 38.826.0 0 1 30.968.0 36.484 36.484.0 0 1 12.76 9.415 44.735 44.735.0 0 1 8.547 15.237 70.624 70.624.0 0 1 0 41.373zm81.141-80.89q-11.147 7.434-18.83 23.041h-.493v-27.005h-19.82V287.78h21.057v-56.984a87.528 87.528.0 0 1 2.478-21.924 41.993 41.993.0 0 1 7.93-16.228 33.951 33.951.0 0 1 14.368-10.158q8.919-3.468 21.555-3.468V156.72q-17.097-.493-28.245 6.937zm80.761-42.366h-21.06v38.402h-21.8v18.581h21.8v81.51a48.668 48.668.0 0 0 1.734 14.37 17.432 17.432.0 0 0 5.326 8.423 20.57 20.57.0 0 0 9.415 4.088 75.59 75.59.0 0 0 13.999 1.115h16.104v-18.582h-9.664a70.335 70.335.0 0 1-8.05-.37 10.361 10.361.0 0 1-4.833-1.611 6.108 6.108.0 0 1-2.354-3.469 23.006 23.006.0 0 1-.617-5.946v-79.528h25.518v-18.581h-25.518zm148.522 60.452a56.135 56.135.0 0 0-18.085-17.962q-11.276-7.063-28.367-7.06a58.263 58.263.0 0 0-24.155 4.953 56.796 56.796.0 0 0-19.079 13.875 63.949 63.949.0 0 0-12.51 21.058 77.064 77.064.0 0 0-4.461 26.758 102.521 102.521.0 0 0 4.338 27.004 58.87 58.87.0 0 0 11.519 21.307 52.43 52.43.0 0 0 18.953 13.873q11.272 4.954 26.632 4.955 21.8.0 36.173-10.901 14.364-10.898 18.58-32.455h-20.81q-2.73 12.635-11.272 18.829-8.549 6.198-21.927 6.195a43.577 43.577.0 0 1-18.085-3.468 35.417 35.417.0 0 1-12.636-9.291 36.127 36.127.0 0 1-7.184-13.38 50.746 50.746.0 0 1-1.981-15.98h95.879a102.07 102.07.0 0 0-2.107-24.526 71.064 71.064.0 0 0-9.415-23.784zm-84.357 29.73a43.81 43.81.0 0 1 3.219-13.999 37.354 37.354.0 0 1 7.433-11.52 34.013 34.013.0 0 1 11.272-7.803 36.694 36.694.0 0 1 14.74-2.85 36.062 36.062.0 0 1 14.494 2.85 36.492 36.492.0 0 1 11.398 7.68 36.107 36.107.0 0 1 7.68 11.52 43.253 43.253.0 0 1 3.345 14.122zm170.95 7.184 44.1-58.964h-25.271l-31.961 44.843-30.721-44.843h-27.006l44.595 60.698-48.063 67.389h25.518l35.677-53.019 35.676 53.019h27.006l-49.55-69.123z" class="cls-1"/></svg></span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/><span class=active>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/changelog/><span>Changelog</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a href=https://twitter.com/cortexmetrics class="nav-link active"><span class=active><i class="fab fa-fw fa-twitter"></i>Twitter</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a href=https://github.com/cortexproject class="nav-link active"><span class=active><i class="fab fa-fw fa-github"></i>Github</span></a></li></ul></div><div class="navbar-nav d-none d-md-block"><div id=search-nav-container><input type=search id=search-input autocomplete=off class="form-control td-search-input" placeholder="&#xf002 Search this siteâ€¦" autocomplete=on><div id=search-results class=container></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><nav class="collapse td-sidebar-nav pt-2 pl-4" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/ class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">Documentation</a></li><ul><li class="collapse show" id=docs><a class="td-sidebar-link td-sidebar-link__page active" id=m-docs-getting-started href=/docs/getting-started/>Getting Started</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-architecture href=/docs/architecture/>Architecture</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-apis href=/docs/apis/>Cortex APIs</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/guides/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Guides</a></li><ul><li class=collapse id=docs-guides><a class="td-sidebar-link td-sidebar-link__page" id=m-docs-guides-running-in-production href=/docs/guides/running-in-production/>Running Cortex in Production</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-guides-auth href=/docs/guides/auth/>Authentication and Authorisation</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-guides-aws href=/docs/guides/aws/>Running Cortex at AWS</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-guides-ruler-sharding href=/docs/guides/ruler-sharding/>Config for horizontally scaling the Ruler</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-guides-ha-pair-handling href=/docs/guides/ha-pair-handling/>Config for sending HA Pairs data to Cortex</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-guides-ingester-handover href=/docs/guides/ingester-handover/>Ingester Hand-over</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-guides-ingesters-with-wal href=/docs/guides/ingesters-with-wal/>Ingesters with WAL</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-guides-tracing href=/docs/guides/tracing/>Tracing</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-guides-cassandra href=/docs/guides/cassandra/>Running Cortex with Cassandra</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/configuration/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Configuration</a></li><ul><li class=collapse id=docs-configuration><a class="td-sidebar-link td-sidebar-link__page" id=m-docs-configuration-configuration-file href=/docs/configuration/configuration-file/>Configuration file</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-configuration-arguments href=/docs/configuration/arguments/>Cortex Arguments Explained</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-configuration-prometheus-frontend href=/docs/configuration/prometheus-frontend/>Prometheus Frontend</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-configuration-single-process-config href=/docs/configuration/single-process-config/>Single-process</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/operations/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Operations</a></li><ul><li class=collapse id=docs-operations><a class="td-sidebar-link td-sidebar-link__page" id=m-docs-operations-blocks-storage href=/docs/operations/blocks-storage/>Blocks storage (experimental)</a></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-docs-changelog href=/docs/changelog/>Changelog</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-code-of-conduct href=/docs/code-of-conduct/>Code of Conduct</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-contributing href=/docs/contributing/>Contributing</a></li></ul></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/cortexproject/cortex/edit/master/content/en/docs/getting_started.md target=_blank><i class="fa fa-edit fa-fw"></i>Edit this page</a>
<a href="https://github.com/cortexproject/cortex/issues/new?title=Getting%20Started" target=_blank><i class="fab fa-github fa-fw"></i>Create documentation issue</a>
<a href=https://github.com/cortexproject/cortex/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i>Create project issue</a></div><nav id=TableOfContents><ul><li><ul><li><a href=#single-instance-single-process>Single instance, single process</a></li><li><a href=#horizontally-scale-out>Horizontally scale out</a></li><li><a href=#high-availability-with-replication>High availability with replication</a></li></ul></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=/docs/>Documentation</a></li><li class="breadcrumb-item active" aria-current=page><a href=/docs/getting-started/>Getting Started</a></li></ol></nav><div class=td-content><h1>Getting Started</h1><p>Cortex can be run as a single binary or as multiple independent microservices.
The single-binary mode is easier to deploy and is aimed mainly at users wanting to try out Cortex or develop on it.
The microservices mode is intended for production usage, as it allows you to independently scale different services and isolate failures.
This document will focus on single-process Cortex.
See <a href=/docs/architecture/>the architecture doc</a> For more information about the microservices.</p><p>Separately from single process vs microservices decision, Cortex can be configured to use local storage or cloud storage (DynamoDB, Bigtable, Cassandra, S3, GCS etc).
This document will focus on using local storage.
Local storage is explicitly not production ready at this time.
Cortex can also make use of external memcacheds for caching and although these are not mandatory, they should be used in production.</p><h2 id=single-instance-single-process>Single instance, single process</h2><p>For simplicity &amp; to get started, we&rsquo;ll run it as a <a href=/docs/configuration/single-process-config/>single process</a> with no dependencies:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ go build ./cmd/cortex
$ ./cortex -config.file<span style=color:#ce5c00;font-weight:700>=</span>./docs/configuration/single-process-config.yaml</code></pre></div><p>This starts a single Cortex node storing chunks and index to your local filesystem in <code>/tmp/cortex</code>.
It is not intended for production use.</p><p>Add the following to your Prometheus config (documentation/examples/prometheus.yml in Prometheus repo):</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>remote_write<span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>-<span style=color:#f8f8f8;text-decoration:underline> </span>url<span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>http<span style=color:#000;font-weight:700>:</span>//localhost<span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>9009</span>/api/prom/push</code></pre></div><p>And start Prometheus with that config file:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ git clone https://github.com/prometheus/prometheus
$ <span style=color:#204a87>cd</span> prometheus
$ go build ./cmd/prometheus
$ ./prometheus --config.file<span style=color:#ce5c00;font-weight:700>=</span>./documentation/examples/prometheus.yml</code></pre></div><p>Your Prometheus instance will now start pushing data to Cortex. To query that data, start a Grafana instance:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ docker run -d --name<span style=color:#ce5c00;font-weight:700>=</span>grafana -p <span style=color:#0000cf;font-weight:700>3000</span>:3000 grafana/grafana</code></pre></div><p>In <a href=http://localhost:3000>the Grafana UI</a> (username/password admin/admin), add a Prometheus datasource for Cortex (<code>http://host.docker.internal:9009/api/prom</code>).</p><p><strong>To clean up:</strong> press CTRL-C in both terminals (for Cortex and Promrtheus) and run <code>docker rm -f grafana</code>.</p><h2 id=horizontally-scale-out>Horizontally scale out</h2><p>Next we&rsquo;re going to show how you can run a scale out Cortex cluster using Docker.
We&rsquo;ll need:
- A built Cortex image.
- A Docker network to put these containers on so they can resolve each other by name.
- A single node Consul instance to coordinate the Cortex cluster.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ make ./cmd/cortex/.uptodate
$ docker network create cortex
$ docker run -d --name<span style=color:#ce5c00;font-weight:700>=</span>consul --network<span style=color:#ce5c00;font-weight:700>=</span>cortex -e <span style=color:#000>CONSUL_BIND_INTERFACE</span><span style=color:#ce5c00;font-weight:700>=</span>eth0 consul</code></pre></div><p>Next we&rsquo;ll run a couple of Cortex instances pointed at that Consul. You&rsquo;ll note with Cortex configuration can be specified in either a config file or overridden on the command line. See <a href=/docs/configuration/arguments/>the arguments documentation</a> for more information about Cortex configuration options.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ docker run -d --name<span style=color:#ce5c00;font-weight:700>=</span>cortex1 --network<span style=color:#ce5c00;font-weight:700>=</span>cortex <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    -v <span style=color:#204a87;font-weight:700>$(</span><span style=color:#204a87>pwd</span><span style=color:#204a87;font-weight:700>)</span>/docs/configuration/single-process-config.yaml:/etc/single-process-config.yaml <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    -p <span style=color:#0000cf;font-weight:700>9001</span>:9009 <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    quay.io/cortexproject/cortex <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    -config.file<span style=color:#ce5c00;font-weight:700>=</span>/etc/single-process-config.yaml <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    -ring.store<span style=color:#ce5c00;font-weight:700>=</span>consul <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    -consul.hostname<span style=color:#ce5c00;font-weight:700>=</span>consul:8500
$ docker run -d --name<span style=color:#ce5c00;font-weight:700>=</span>cortex2 --network<span style=color:#ce5c00;font-weight:700>=</span>cortex <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    -v <span style=color:#204a87;font-weight:700>$(</span><span style=color:#204a87>pwd</span><span style=color:#204a87;font-weight:700>)</span>/docs/configuration/single-process-config.yaml:/etc/single-process-config.yaml <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    -p <span style=color:#0000cf;font-weight:700>9002</span>:9009 <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    quay.io/cortexproject/cortex <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    -config.file<span style=color:#ce5c00;font-weight:700>=</span>/etc/single-process-config.yaml <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    -ring.store<span style=color:#ce5c00;font-weight:700>=</span>consul <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    -consul.hostname<span style=color:#ce5c00;font-weight:700>=</span>consul:8500</code></pre></div><p>If you go to <a href=http://localhost:9001/ring>http://localhost:9001/ring</a> (or <a href=http://localhost:9002/ring>http://localhost:9002/ring</a>) you should see both Cortex nodes join the ring.</p><p>To demonstrate the correct operation of Cortex clustering, we&rsquo;ll send samples
to one of the instances and queries to another. In production, you&rsquo;d want to
load balance both pushes and queries evenly among all the nodes.</p><p>Point Prometheus at the first:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>remote_write<span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>-<span style=color:#f8f8f8;text-decoration:underline> </span>url<span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>http<span style=color:#000;font-weight:700>:</span>//localhost<span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>9001</span>/api/prom/push</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ ./prometheus --config.file<span style=color:#ce5c00;font-weight:700>=</span>./documentation/examples/prometheus.yml</code></pre></div><p>And Grafana at the second:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ docker run -d --name<span style=color:#ce5c00;font-weight:700>=</span>grafana --network<span style=color:#ce5c00;font-weight:700>=</span>cortex -p <span style=color:#0000cf;font-weight:700>3000</span>:3000 grafana/grafana</code></pre></div><p>In <a href=http://localhost:3000>the Grafana UI</a> (username/password admin/admin), add a Prometheus datasource for Cortex (<code>http://cortex2:9009/api/prom</code>).</p><p><strong>To clean up:</strong> CTRL-C the Prometheus process and run:</p><pre><code>$ docker rm -f cortex1 cortex2 consul grafana
$ docker network remove cortex
</code></pre><h2 id=high-availability-with-replication>High availability with replication</h2><p>In this last demo we&rsquo;ll show how Cortex can replicate data among three nodes,
and demonstrate Cortex can tolerate a node failure without affecting reads and writes.</p><p>First, create a network and run a new Consul and Grafana:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ docker network create cortex
$ docker run -d --name<span style=color:#ce5c00;font-weight:700>=</span>consul --network<span style=color:#ce5c00;font-weight:700>=</span>cortex -e <span style=color:#000>CONSUL_BIND_INTERFACE</span><span style=color:#ce5c00;font-weight:700>=</span>eth0 consul
$ docker run -d --name<span style=color:#ce5c00;font-weight:700>=</span>grafana --network<span style=color:#ce5c00;font-weight:700>=</span>cortex -p <span style=color:#0000cf;font-weight:700>3000</span>:3000 grafana/grafana</code></pre></div><p>Finally, launch 3 Cortex nodes with replication factor 3:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ docker run -d --name<span style=color:#ce5c00;font-weight:700>=</span>cortex1 --network<span style=color:#ce5c00;font-weight:700>=</span>cortex <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    -v <span style=color:#204a87;font-weight:700>$(</span><span style=color:#204a87>pwd</span><span style=color:#204a87;font-weight:700>)</span>/docs/configuration/single-process-config.yaml:/etc/single-process-config.yaml <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    -p <span style=color:#0000cf;font-weight:700>9001</span>:9009 <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    quay.io/cortexproject/cortex <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    -config.file<span style=color:#ce5c00;font-weight:700>=</span>/etc/single-process-config.yaml <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    -ring.store<span style=color:#ce5c00;font-weight:700>=</span>consul <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    -consul.hostname<span style=color:#ce5c00;font-weight:700>=</span>consul:8500 <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    -distributor.replication-factor<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span>
$ docker run -d --name<span style=color:#ce5c00;font-weight:700>=</span>cortex2 --network<span style=color:#ce5c00;font-weight:700>=</span>cortex <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    -v <span style=color:#204a87;font-weight:700>$(</span><span style=color:#204a87>pwd</span><span style=color:#204a87;font-weight:700>)</span>/docs/configuration/single-process-config.yaml:/etc/single-process-config.yaml <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    -p <span style=color:#0000cf;font-weight:700>9002</span>:9009 <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    quay.io/cortexproject/cortex <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    -config.file<span style=color:#ce5c00;font-weight:700>=</span>/etc/single-process-config.yaml <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    -ring.store<span style=color:#ce5c00;font-weight:700>=</span>consul <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    -consul.hostname<span style=color:#ce5c00;font-weight:700>=</span>consul:8500 <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    -distributor.replication-factor<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span>
$ docker run -d --name<span style=color:#ce5c00;font-weight:700>=</span>cortex3 --network<span style=color:#ce5c00;font-weight:700>=</span>cortex <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    -v <span style=color:#204a87;font-weight:700>$(</span><span style=color:#204a87>pwd</span><span style=color:#204a87;font-weight:700>)</span>/docs/configuration/single-process-config.yaml:/etc/single-process-config.yaml <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    -p <span style=color:#0000cf;font-weight:700>9003</span>:9009 <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    quay.io/cortexproject/cortex <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    -config.file<span style=color:#ce5c00;font-weight:700>=</span>/etc/single-process-config.yaml <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    -ring.store<span style=color:#ce5c00;font-weight:700>=</span>consul <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    -consul.hostname<span style=color:#ce5c00;font-weight:700>=</span>consul:8500 <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    -distributor.replication-factor<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span></code></pre></div><p>Configure Prometheus to send data to the first replica:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>remote_write<span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>-<span style=color:#f8f8f8;text-decoration:underline> </span>url<span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>http<span style=color:#000;font-weight:700>:</span>//localhost<span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>9001</span>/api/prom/push</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ ./prometheus --config.file<span style=color:#ce5c00;font-weight:700>=</span>./documentation/examples/prometheus.yml</code></pre></div><p>In Grafana, add a datasource for the 3rd Cortex replica (<code>http://cortex3:9009/api/prom</code>)
and verify the same data appears in both Prometheus and Cortex.</p><p>To show that Cortex can tolerate a node failure, hard kill one of the Cortex replicas:</p><pre><code>$ docker rm -f cortex2
</code></pre><p>You should see writes and queries continue to work without error.</p><p><strong>To clean up:</strong> CTRL-C the Prometheus process and run:</p><pre><code>$ docker rm -f cortex1 cortex2 cortex3 consul grafana
$ docker network remove cortex
</code></pre><div class="text-muted mt-5 pt-3 border-top"></div></div></main></div></div><footer class="row td-box td-box--dark td-box--gradient td-box--height-auto text-white p-5"><div class="col-12 col-sm-4 pb-5 pb-sm-0"><img src=/images/cortex-stacked-white.png width=75px class="img-fluid float-left"></div><div class="col-12 col-sm-4 pb-5 pb-sm-0"><h6 class=font-weight-bold>Community</h6><ul class=list-unstyled><li><a href=https://slack.cncf.io class="text-reset text-white"><i class="fab fa-fw fa-slack"></i>Slack</a></li><li><a href=https://github.com/cortexproject/cortex class="text-reset text-white"><i class="fab fa-fw fa-github"></i>GitHub</a></li><li><a href=https://twitter.com/cortexmetrics class="text-reset text-white"><i class="fab fa-fw fa-twitter"></i>Twitter</a></li></ul></div><div class="col-12 col-sm-4"><h6 class=font-weight-bold>About</h6><p>Cortex is an OSS licensed project as Apache License 2.0</p></div></footer></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=/js/main.min.29b0315468c00226fa6f4556a9cebc0ac4fe1ce1457a01b22c0a06b329877383.js integrity="sha256-KbAxVGjAAib6b0VWqc68CsT&#43;HOFFegGyLAoGsymHc4M=" crossorigin=anonymous></script></body></html>