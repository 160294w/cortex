<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.59.1"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Running Cortex in Production | Cortex</title><meta property="og:title" content="Running Cortex in Production"><meta property="og:description" content="This document assumes you have read the architecture document.
In addition to the general advice in this document, please see these platform-specific notes:
 AWS  Planning Tenants If you will run Cortex as a multi-tenant system, you need to give each tenant a unique ID - this can be any string. Managing tenants and allocating IDs must be done outside of Cortex. You must also configure Authentication and Authorisation."><meta property="og:type" content="article"><meta property="og:url" content="/docs/guides/running-in-production/"><meta property="og:image" content="/images/logo-twitter-card.jpg"><meta property="og:site_name" content="Cortex"><meta itemprop=name content="Running Cortex in Production"><meta itemprop=description content="This document assumes you have read the architecture document.
In addition to the general advice in this document, please see these platform-specific notes:
 AWS  Planning Tenants If you will run Cortex as a multi-tenant system, you need to give each tenant a unique ID - this can be any string. Managing tenants and allocating IDs must be done outside of Cortex. You must also configure Authentication and Authorisation."><meta itemprop=wordCount content="1332"><meta itemprop=keywords content><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/images/logo-twitter-card.jpg"><meta name=twitter:title content="Running Cortex in Production"><meta name=twitter:description content="This document assumes you have read the architecture document.
In addition to the general advice in this document, please see these platform-specific notes:
 AWS  Planning Tenants If you will run Cortex as a multi-tenant system, you need to give each tenant a unique ID - this can be any string. Managing tenants and allocating IDs must be done outside of Cortex. You must also configure Authentication and Authorisation."><link rel=preload href=/scss/main.min.4ff813ae4617e8aa437e422dee0b5f0d0d29f44049ee9dc629d104243b05d88b.css as=style><link href=/scss/main.min.4ff813ae4617e8aa437e422dee0b5f0d0d29f44049ee9dc629d104243b05d88b.css rel=stylesheet integrity><link href=/css/offline-search.css rel=stylesheet><script src=https://code.jquery.com/jquery-3.3.1.min.js integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin=anonymous></script><script src=https://unpkg.com/lunr@2.1.6/lunr.js></script><script src=/js/offline-search.js></script><title>Running Cortex in Production | Cortex</title></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar navbar-nocover"><a id=cortex-logo class=navbar-brand href=/><span class=navbar-logo><svg xmlns="http://www.w3.org/2000/svg" role="img" viewBox="-17.92 -14.92 1191.84 462.84"><defs><style>.cls-1{fill:#fff}</style></defs><path d="M214.531 8.017C99.353 8.017 5.65 101.72 5.65 216.899S99.353 425.78 214.531 425.78s208.882-93.704 208.882-208.882S329.71 8.017 214.531 8.017zm0 408.558c-110.102.0-199.676-89.574-199.676-199.676S104.429 17.222 214.53 17.222 414.208 106.797 414.208 216.9 324.633 416.575 214.53 416.575z" class="cls-1"/><circle cx="327.452" cy="221.633" r="34.571" class="cls-1"/><circle cx="213.713" cy="353.584" r="34.571" class="cls-1"/><path d="M299.992 167.913l-59-56.05a34.578 34.578.0 1 0-4.343 4.34l57.828 54.937a60.158 60.158.0 0 0-27.168 49.123h-12.97l-23.456-67.02-26.055 64.718H175.73l-24.724 57.22-21.808-54.524-.063.025v-.586h-22.048a34.582 34.582.0 1 0-.275 6.138h18.005l25.97 64.925 28.977-67.06h29.207l21.51-53.424 19.503 55.725H267.5a60.173 60.173.0 0 0 25.202 44.11l-56.52 56.52 4.34 4.338 57.492-57.492a60.155 60.155.0 1 0 1.977-105.963zm81.481 53.515a54.02 54.02.0 1 1-54.022-54.02 54.083 54.083.0 0 1 54.022 54.02zm175.707 42.568q-8.797 8.178-24.405 8.177a34.858 34.858.0 0 1-17.095-3.965 33.188 33.188.0 0 1-11.643-10.529 46.374 46.374.0 0 1-6.566-14.99 71.134 71.134.0 0 1-2.105-17.341 86.99 86.99.0 0 1 1.982-18.706 46.804 46.804.0 0 1 6.565-15.98 34.028 34.028.0 0 1 12.263-11.149q7.675-4.21 19.077-4.212 13.38.0 21.306 6.69 7.927 6.689 10.405 18.829h21.803a50.76 50.76.0 0 0-5.946-19.696 44.06 44.06.0 0 0-12.015-13.75 49.842 49.842.0 0 0-16.848-8.051 77.44 77.44.0 0 0-20.44-2.601q-15.114.0-26.509 5.326a52.935 52.935.0 0 0-18.952 14.617 62.165 62.165.0 0 0-11.273 21.8 94.013 94.013.0 0 0-3.717 26.883 86.195 86.195.0 0 0 3.84 26.386 57.783 57.783.0 0 0 11.397 20.686 50.138 50.138.0 0 0 18.829 13.38 66.766 66.766.0 0 0 25.891 4.705q24.527.0 38.772-12.882 14.245-12.878 17.715-36.668h-21.556q-1.986 14.867-10.776 23.041zm157.44-87.828a56.338 56.338.0 0 0-19.447-14.244q-11.52-5.203-26.882-5.203-15.115.0-26.756 5.203a56.009 56.009.0 0 0-19.573 14.244 59.75 59.75.0 0 0-11.892 21.307 85.299 85.299.0 0 0-3.965 26.386 84.117 84.117.0 0 0 3.965 26.262 59.853 59.853.0 0 0 11.892 21.183 54.61 54.61.0 0 0 19.573 14.12q11.643 5.077 26.756 5.08 15.36.0 26.882-5.08a54.908 54.908.0 0 0 19.447-14.12 59.95 59.95.0 0 0 11.892-21.183 84.181 84.181.0 0 0 3.965-26.262 85.364 85.364.0 0 0-3.965-26.386 59.846 59.846.0 0 0-11.892-21.307zm-9.538 68.38a43.305 43.305.0 0 1-8.548 15.113 37.061 37.061.0 0 1-12.759 9.29 38.825 38.825.0 0 1-30.968.0 37.003 37.003.0 0 1-12.76-9.29 43.209 43.209.0 0 1-8.547-15.114 70.669 70.669.0 0 1 0-41.373 44.634 44.634.0 0 1 8.547-15.237 36.428 36.428.0 0 1 12.76-9.415 38.826 38.826.0 0 1 30.968.0 36.484 36.484.0 0 1 12.76 9.415 44.735 44.735.0 0 1 8.547 15.237 70.624 70.624.0 0 1 0 41.373zm81.141-80.89q-11.147 7.434-18.83 23.041h-.493v-27.005h-19.82V287.78h21.057v-56.984a87.528 87.528.0 0 1 2.478-21.924 41.993 41.993.0 0 1 7.93-16.228 33.951 33.951.0 0 1 14.368-10.158q8.919-3.468 21.555-3.468V156.72q-17.097-.493-28.245 6.937zm80.761-42.366h-21.06v38.402h-21.8v18.581h21.8v81.51a48.668 48.668.0 0 0 1.734 14.37 17.432 17.432.0 0 0 5.326 8.423 20.57 20.57.0 0 0 9.415 4.088 75.59 75.59.0 0 0 13.999 1.115h16.104v-18.582h-9.664a70.335 70.335.0 0 1-8.05-.37 10.361 10.361.0 0 1-4.833-1.611 6.108 6.108.0 0 1-2.354-3.469 23.006 23.006.0 0 1-.617-5.946v-79.528h25.518v-18.581h-25.518zm148.522 60.452a56.135 56.135.0 0 0-18.085-17.962q-11.276-7.063-28.367-7.06a58.263 58.263.0 0 0-24.155 4.953 56.796 56.796.0 0 0-19.079 13.875 63.949 63.949.0 0 0-12.51 21.058 77.064 77.064.0 0 0-4.461 26.758 102.521 102.521.0 0 0 4.338 27.004 58.87 58.87.0 0 0 11.519 21.307 52.43 52.43.0 0 0 18.953 13.873q11.272 4.954 26.632 4.955 21.8.0 36.173-10.901 14.364-10.898 18.58-32.455h-20.81q-2.73 12.635-11.272 18.829-8.549 6.198-21.927 6.195a43.577 43.577.0 0 1-18.085-3.468 35.417 35.417.0 0 1-12.636-9.291 36.127 36.127.0 0 1-7.184-13.38 50.746 50.746.0 0 1-1.981-15.98h95.879a102.07 102.07.0 0 0-2.107-24.526 71.064 71.064.0 0 0-9.415-23.784zm-84.357 29.73a43.81 43.81.0 0 1 3.219-13.999 37.354 37.354.0 0 1 7.433-11.52 34.013 34.013.0 0 1 11.272-7.803 36.694 36.694.0 0 1 14.74-2.85 36.062 36.062.0 0 1 14.494 2.85 36.492 36.492.0 0 1 11.398 7.68 36.107 36.107.0 0 1 7.68 11.52 43.253 43.253.0 0 1 3.345 14.122zm170.95 7.184 44.1-58.964h-25.271l-31.961 44.843-30.721-44.843h-27.006l44.595 60.698-48.063 67.389h25.518l35.677-53.019 35.676 53.019h27.006l-49.55-69.123z" class="cls-1"/></svg></span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/><span class=active>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/changelog/><span class=active>Changelog</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a href=https://twitter.com/cortexmetrics class="nav-link active"><span class=active><i class="fab fa-fw fa-twitter"></i>Twitter</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a href=https://github.com/cortexproject class="nav-link active"><span class=active><i class="fab fa-fw fa-github"></i>Github</span></a></li></ul></div><div class="navbar-nav d-none d-md-block"><div id=search-nav-container><input type=search id=search-input autocomplete=off class="form-control td-search-input" placeholder="&#xf002 Search this siteâ€¦" autocomplete=on><div id=search-results class=container></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><nav class="collapse td-sidebar-nav pt-2 pl-4" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">Documentation</a></li><ul><li class="collapse show" id=docs><a class="td-sidebar-link td-sidebar-link__page" id=m-docs-getting-started href=/docs/getting-started/>Getting Started</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-architecture href=/docs/architecture/>Architecture</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-apis href=/docs/apis/>Cortex APIs</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/guides/ class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">Guides</a></li><ul><li class="collapse show" id=docs-guides><a class="td-sidebar-link td-sidebar-link__page active" id=m-docs-guides-running-in-production href=/docs/guides/running-in-production/>Running Cortex in Production</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-guides-auth href=/docs/guides/auth/>Authentication and Authorisation</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-guides-aws href=/docs/guides/aws/>Running Cortex at AWS</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-guides-ha-pair-handling href=/docs/guides/ha-pair-handling/>Config for sending HA Pairs data to Cortex</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-guides-ingester-handover href=/docs/guides/ingester-handover/>Ingester Hand-over</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-guides-tracing href=/docs/guides/tracing/>Tracing</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-guides-cassandra href=/docs/guides/cassandra/>Running Cortex with Cassandra</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/configuration/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Configuration</a></li><ul><li class=collapse id=docs-configuration><a class="td-sidebar-link td-sidebar-link__page" id=m-docs-configuration-arguments href=/docs/configuration/arguments/>Cortex Arguments Explained</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-configuration-prometheus-frontend href=/docs/configuration/prometheus-frontend/>Prometheus Frontend</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-configuration-single-process-config href=/docs/configuration/single-process-config/>Single-process</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/operations/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Operations</a></li><ul><li class=collapse id=docs-operations><a class="td-sidebar-link td-sidebar-link__page" id=m-docs-operations-blocks-storage href=/docs/operations/blocks-storage/>Blocks storage (experimental)</a></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-docs-changelog href=/docs/changelog/>Changelog</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-code-of-conduct href=/docs/code-of-conduct/>Code of Conduct</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docs-contributing href=/docs/contributing/>Contributing</a></li></ul></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/cortexproject/cortex/edit/master/content/en/docs/guides/running.md target=_blank><i class="fa fa-edit fa-fw"></i>Edit this page</a>
<a href="https://github.com/cortexproject/cortex/issues/new?title=Running%20Cortex%20in%20Production" target=_blank><i class="fab fa-github fa-fw"></i>Create documentation issue</a>
<a href=https://github.com/cortexproject/cortex/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i>Create project issue</a></div><nav id=TableOfContents><ul><li><ul><li><a href=#planning>Planning</a><ul><li><a href=#tenants>Tenants</a></li><li><a href=#storage>Storage</a></li><li><a href=#components>Components</a></li><li><a href=#other-dependencies>Other dependencies</a></li><li><a href=#ingester-replication-factor>Ingester replication factor</a></li><li><a href=#schema>Schema</a><ul><li><a href=#schema-periodic-table>Schema periodic table</a></li><li><a href=#schema-version>Schema version</a></li></ul></li><li><a href=#chunk-encoding>Chunk encoding</a></li><li><a href=#sizing>Sizing</a></li><li><a href=#caching>Caching</a></li><li><a href=#orchestration>Orchestration</a></li></ul></li><li><a href=#configuration>Configuration</a><ul><li><a href=#resource-requests>Resource requests</a></li><li><a href=#take-extra-care-with-ingesters>Take extra care with ingesters</a></li><li><a href=#remote-writing-prometheus>Remote writing Prometheus</a></li></ul></li><li><a href=#optimising>Optimising</a><ul><li><a href=#optimising-storage>Optimising Storage</a></li></ul></li></ul></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=/docs/>Documentation</a></li><li class=breadcrumb-item><a href=/docs/guides/>Guides</a></li><li class="breadcrumb-item active" aria-current=page><a href=/docs/guides/running-in-production/>Running Cortex in Production</a></li></ol></nav><div class=td-content><h1>Running Cortex in Production</h1><p>This document assumes you have read the
<a href=/docs/architecture/>architecture</a> document.</p><p>In addition to the general advice in this document, please see these
platform-specific notes:</p><ul><li><a href=/docs/guides/aws/>AWS</a></li></ul><h2 id=planning>Planning</h2><h3 id=tenants>Tenants</h3><p>If you will run Cortex as a multi-tenant system, you need to give each
tenant a unique ID - this can be any string. Managing tenants and
allocating IDs must be done outside of Cortex. You must also configure
<a href=/docs/guides/auth/>Authentication and Authorisation</a>.</p><h3 id=storage>Storage</h3><p>Cortex requires a scalable storage back-end. Commercial cloud options
are DynamoDB and Bigtable: the advantage is you don&rsquo;t have to know how
to manage them, but the downside is they have specific costs.
Alternatively you can choose Cassandra, which you will have to install
and manage.</p><h3 id=components>Components</h3><p>Every Cortex installation will need Distributor, Ingester and Querier.
Alertmanager, Ruler and Query-frontend are optional.</p><h3 id=other-dependencies>Other dependencies</h3><p>Cortex needs a KV store to track sharding of data between
processes. This can be either Etcd or Consul.</p><p>If you want to configure recording and alerting rules (i.e. if you
will run the Ruler and Alertmanager components) then a Postgres
database is required to store configs.</p><p>Memcached is not essential but highly recommended.</p><h3 id=ingester-replication-factor>Ingester replication factor</h3><p>The standard replication factor is three, so that we can drop one
replica and be unconcerned, as we still have two copies of the data
left for redundancy. This is configurable: you can run with more
redundancy or less, depending on your risk appetite.</p><h3 id=schema>Schema</h3><h4 id=schema-periodic-table>Schema periodic table</h4><p>The periodic table from argument (<code>-dynamodb.periodic-table.from=&lt;date&gt;</code> if
using command line flags, the <code>from</code> field for the first schema entry if using
YAML) should be set to the date the oldest metrics you will be sending to
Cortex. Generally that means set it to the date you are first deploying this
instance. If you use an example date from years ago table-manager will create
hundreds of tables. You can also avoid creating too many tables by setting a
reasonable retention in the table-manager
(<code>-table-manager.retention-period=&lt;duration&gt;</code>).</p><h4 id=schema-version>Schema version</h4><p>Choose schema version 9 in most cases; version 10 if you expect
hundreds of thousands of timeseries under a single name. Anything
older than v9 is much less efficient.</p><h3 id=chunk-encoding>Chunk encoding</h3><p>Standard choice would be Bigchunk, which is the most flexible chunk
encoding. You may get better compression from Varbit, if many of your
timeseries do not change value from one day to the next.</p><h3 id=sizing>Sizing</h3><p>You will want to estimate how many nodes are required, how many of
each component to run, and how much storage space will be required.
In practice, these will vary greatly depending on the metrics being
sent to Cortex.</p><p>Some key parameters are:</p><ol><li>The number of active series. If you have Prometheus already you
can query <code>prometheus_tsdb_head_series</code> to see this number.</li><li>Sampling rate, e.g. a new sample for each series every 15
seconds. Multiply this by the number of active series to get the
total rate at which samples will arrive at Cortex.</li><li>The rate at which series are added and removed. This can be very
high if you monitor objects that come and go - for example if you run
thousands of batch jobs lasting a minute or so and capture metrics
with a unique ID for each one. <a href=https://www.robustperception.io/using-tsdb-analyze-to-investigate-churn-and-cardinality>Read how to analyse this on
Prometheus</a></li><li>How compressible the time-series data are. If a metric stays at
the same value constantly, then Cortex can compress it very well, so
12 hours of data sampled every 15 seconds would be around 2KB. On
the other hand if the value jumps around a lot it might take 10KB.
There are not currently any tools available to analyse this.</li><li>How long you want to retain data for, e.g. 1 month or 2 years.</li></ol><p>Other parameters which can become important if you have particularly
high values:</p><ol><li>Number of different series under one metric name.</li><li>Number of labels per series.</li><li>Rate and complexity of queries.</li></ol><p>Now, some rules of thumb:</p><ol><li>Each million series in an ingester takes 15GB of RAM. Total number
of series in ingesters is number of active series times the
replication factor. This is with the default of 12-hour chunks - RAM
required will reduce if you set <code>-ingester.max-chunk-age</code> lower
(trading off more back-end database IO)</li><li>Each million series (including churn) consumes 15GB of chunk
storage and 4GB of index, per day (so multiply by the retention
period).</li><li>Each 100,000 samples/sec arriving takes 1 CPU in distributors.
Distributors don&rsquo;t need much RAM.</li></ol><p>If you turn on compression between distributors and ingesters (for
example to save on inter-zone bandwidth charges at AWS) they will use
significantly more CPU (approx 100% more for distributor and 50% more
for ingester).</p><h3 id=caching>Caching</h3><p>Cortex can retain data in-process or in Memcached to speed up various
queries by caching:</p><ul><li>individual chunks</li><li>index lookups for one label on one day</li><li>the results of a whole query</li></ul><p>You should always include Memcached in your Cortex install so results
from one process can be re-used by another. In-process caching can cut
fetch times slightly and reduce the load on Memcached.</p><p>Ingesters can also be configured to use Memcached to avoid re-writing
index and chunk data which has already been stored in the back-end
database. Again, highly recommended.</p><h3 id=orchestration>Orchestration</h3><p>Because Cortex is designed to run multiple instances of each component
(ingester, querier, etc.), you probably want to automate the placement
and shepherding of these instances. Most users choose Kubernetes to do
this, but this is not mandatory.</p><h2 id=configuration>Configuration</h2><h3 id=resource-requests>Resource requests</h3><p>If using Kubernetes, each container should specify resource requests
so that the scheduler can place them on a node with sufficient capacity.</p><p>For example an ingester might request:</p><pre><code>        resources:
          requests:
            cpu: 4
            memory: 10Gi
</code></pre><p>The specific values here should be adjusted based on your own
experiences running Cortex - they are very dependent on rate of data
arriving and other factors such as series churn.</p><h3 id=take-extra-care-with-ingesters>Take extra care with ingesters</h3><p>Ingesters hold hours of timeseries data in memory; you can configure
Cortex to replicate the data but you should take steps to avoid losing
all replicas at once:
- Don&rsquo;t run multiple ingesters on the same node.
- Don&rsquo;t run ingesters on preemptible/spot nodes.
- Spread out ingesters across racks / availability zones / whatever
applies in your datacenters.</p><p>You can ask Kubernetes to avoid running on the same node like this:</p><pre><code>      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: name
                  operator: In
                  values:
                  - ingester
              topologyKey: &quot;kubernetes.io/hostname&quot;
</code></pre><p>Give plenty of time for an ingester to hand over or flush data to
store when shutting down; for Kubernetes this looks like:</p><pre><code>      terminationGracePeriodSeconds: 2400
</code></pre><p>Ask Kubernetes to limit rolling updates to one ingester at a time, and
signal the old one to stop before the new one is ready:</p><pre><code>  strategy:
    rollingUpdate:
      maxSurge: 0
      maxUnavailable: 1
</code></pre><p>Ingesters provide an http hook to signal readiness when all is well;
this is valuable because it stops a rolling update at the first
problem:</p><pre><code>        readinessProbe:
          httpGet:
            path: /ready
            port: 80
</code></pre><p>We do not recommend configuring a liveness probe on ingesters -
killing them is a last resort and should not be left to a machine.</p><h3 id=remote-writing-prometheus>Remote writing Prometheus</h3><p>To configure your Prometheus instances for remote writes take a look at
the <a href=https://prometheus.io/docs/prometheus/latest/configuration/configuration/#remote_write>Prometheus Remote Write Config</a>. We recommend to tune the following
parameters of the <code>queue_config</code>:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>remote_write<span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>-<span style=color:#f8f8f8;text-decoration:underline> </span>queue_config<span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>capacity<span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5000</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>max_shards<span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>min_shards<span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>max_samples_per_send<span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span></code></pre></div><p>Please take note that these values are tweaked for our use cases
and may be necessary to adapt depending on your workload. Take a
look at the <a href=https://prometheus.io/docs/practices/remote_write/>remote write tuning docs</a>.</p><p>If you experience a rather high delay for your metrics to appear in
Cortex (15s+) you can try increasing the <code>min_shards</code> in your remote
write config. Sometimes Prometheus does not increase the number of
shards even though it hasn&rsquo;t caught up the lag. You can monitor the
delay with this Prometheus query:</p><pre><code>time() - sum by (statefulset_kubernetes_io_pod_name) (prometheus_remote_storage_queue_highest_sent_timestamp_seconds)
</code></pre><h2 id=optimising>Optimising</h2><h3 id=optimising-storage>Optimising Storage</h3><p>These ingester options reduce the chance of storing multiple copies of
the same data:</p><pre><code>    -ingester.spread-flushes=true
    -ingester.chunk-age-jitter=0
</code></pre><p>Add a chunk cache via <code>-memcached.hostname</code> to allow writes to be de-duplicated.</p><p>As recommended under <a href=#chunk-encoding>Chunk encoding</a>, use Bigchunk:</p><pre><code>    -ingester.chunk-encoding=3 # bigchunk
</code></pre><div class="text-muted mt-5 pt-3 border-top"></div></div></main></div></div><footer class="row td-box td-box--dark td-box--gradient td-box--height-auto text-white p-5"><div class="col-12 col-sm-4 pb-5 pb-sm-0"><img src=/images/cortex-stacked-white.png width=75px class="img-fluid float-left"></div><div class="col-12 col-sm-4 pb-5 pb-sm-0"><h6 class=font-weight-bold>Community</h6><ul class=list-unstyled><li><a href=https://slack.cncf.io class="text-reset text-white"><i class="fab fa-fw fa-slack"></i>Slack</a></li><li><a href=https://github.com/cortexproject/cortex class="text-reset text-white"><i class="fab fa-fw fa-github"></i>GitHub</a></li><li><a href=https://twitter.com/cortexmetrics class="text-reset text-white"><i class="fab fa-fw fa-twitter"></i>Twitter</a></li></ul></div><div class="col-12 col-sm-4"><h6 class=font-weight-bold>About</h6><p>Cortex is an OSS licensed project as Apache License 2.0</p></div></footer></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=/js/main.min.29b0315468c00226fa6f4556a9cebc0ac4fe1ce1457a01b22c0a06b329877383.js integrity="sha256-KbAxVGjAAib6b0VWqc68CsT&#43;HOFFegGyLAoGsymHc4M=" crossorigin=anonymous></script></body></html>